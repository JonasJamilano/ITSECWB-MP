<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Accounts & Assign Roles</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
    <h1>Manage Accounts & Assign Roles</h1>
    <table border="1">
        <thead>
            <tr>
                <th>Username</th>
                <th>Current Role</th>
                <th>Change Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
    </table>

    <script>
    document.addEventListener("DOMContentLoaded", async () => {
        // Note: for now no real auth token required because backend adminCheck allows all.
        const token = localStorage.getItem("authToken");
        if (!token) {
            alert("You must log in as an admin first.");
            window.location.href = "adminlogin.html";
            return;
        }

        try {
            const res = await fetch("/webcafe/users", {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Failed to load users");
            const users = await res.json();

            const tableBody = document.getElementById("usersTableBody");
            tableBody.innerHTML = "";

            users.forEach(user => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>
                        <select id="role-${user._id}">
                            <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
                            <option value="roleA" ${user.role === "roleA" ? "selected" : ""}>Role A</option>
                            <option value="customer" ${user.role === "customer" ? "selected" : ""}>Customer</option>
                        </select>
                        <button onclick="changeRole('${user._id}')">Change Role</button>
                    </td>
                    <td>
                        <button onclick="deleteAccount('${user._id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        } catch (err) {
            alert(err.message);
        }
    });

    async function changeRole(userId) {
        const token = localStorage.getItem("authToken");
        const newRole = document.getElementById(`role-${userId}`).value;

        const res = await fetch(`/webcafe/users/${userId}/role`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ role: newRole })
        });

        if (res.ok) {
            alert("Role updated successfully");
            location.reload();
        } else {
            alert("Failed to update role");
        }
    }

    async function deleteAccount(userId) {
        const token = localStorage.getItem("authToken");

        const res = await fetch(`/webcafe/users/${userId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
        });

        if (res.ok) {
            alert("Account deleted successfully");
            location.reload();
        } else {
            alert("Failed to delete account");
        }
    }
    </script>
</body>
</html>
